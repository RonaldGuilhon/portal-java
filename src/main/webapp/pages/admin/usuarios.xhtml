<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets">

<h:head>
    <title>Gerenciar Usuários - Portal de Notícias</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <h:outputStylesheet library="css" name="style.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
</h:head>

<h:body>
    <f:view>
        <!-- Verificação de autenticação e autorização -->
        <f:event type="preRenderView" listener="#{loginController.verificarAutenticacao}"/>
        <f:event type="preRenderView" listener="#{usuarioController.verificarPermissaoAdmin}"/>
        
        <!-- Navbar Admin -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <h:link class="navbar-brand" outcome="/pages/admin/listar.xhtml">
                    <i class="fas fa-newspaper"></i> Portal Admin
                </h:link>
                
                <div class="navbar-nav me-auto">
                    <h:link class="nav-link" outcome="/pages/admin/listar.xhtml">
                        <i class="fas fa-list"></i> Notícias
                    </h:link>
                    <h:link class="nav-link active" outcome="/pages/admin/usuarios.xhtml">
                        <i class="fas fa-users"></i> Usuários
                    </h:link>
                </div>
                
                <div class="navbar-nav">
                    <span class="navbar-text me-3">
                        <i class="fas fa-user"></i> #{loginController.usuarioLogado.nome}
                    </span>
                    <h:form>
                        <h:commandLink action="#{loginController.logout}" styleClass="nav-link">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </h:commandLink>
                    </h:form>
                </div>
            </div>
        </nav>
        
        <!-- Conteúdo Principal -->
        <div class="container-fluid mt-4">
            <div class="row">
                <div class="col-12">
                    <!-- Cabeçalho -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-users"></i> Gerenciar Usuários</h2>
                            <p class="text-muted">Gerencie todos os usuários do sistema</p>
                        </div>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalUsuario" 
                                onclick="#{usuarioController.novoUsuario()}">
                            <i class="fas fa-plus"></i> Novo Usuário
                        </button>
                    </div>
                    
                    <!-- Mensagens -->
                    <h:messages globalOnly="true" styleClass="alert alert-info" 
                               showDetail="true" showSummary="false"/>
                    
                    <!-- Filtros -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h:form>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Buscar por nome:</label>
                                        <h:inputText value="#{usuarioController.filtroNome}" 
                                                   styleClass="form-control" 
                                                   placeholder="Digite o nome..."/>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Buscar por email:</label>
                                        <h:inputText value="#{usuarioController.filtroEmail}" 
                                                   styleClass="form-control" 
                                                   placeholder="Digite o email..."/>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Perfil:</label>
                                        <h:selectOneMenu value="#{usuarioController.filtroPerfil}" 
                                                       styleClass="form-select">
                                            <f:selectItem itemValue="" itemLabel="Todos"/>
                                            <f:selectItems value="#{usuarioController.perfisDisponiveis}" 
                                                         var="perfil" 
                                                         itemValue="#{perfil}" 
                                                         itemLabel="#{perfil}"/>
                                        </h:selectOneMenu>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <h:commandButton value="Filtrar" 
                                                       action="#{usuarioController.filtrar}"
                                                       styleClass="btn btn-outline-primary me-2">
                                            <i class="fas fa-search"></i>
                                        </h:commandButton>
                                        <h:commandButton value="Limpar" 
                                                       action="#{usuarioController.limparFiltros}"
                                                       styleClass="btn btn-outline-secondary">
                                            <i class="fas fa-eraser"></i>
                                        </h:commandButton>
                                    </div>
                                </div>
                            </h:form>
                        </div>
                    </div>
                    
                    <!-- Tabela de Usuários -->
                    <div class="card">
                        <div class="card-body">
                            <h:form>
                                <div class="table-responsive">
                                    <h:dataTable value="#{usuarioController.usuarios}" var="usuario" 
                                               styleClass="table table-striped table-hover"
                                               headerClass="table-dark">
                                        
                                        <h:column>
                                            <f:facet name="header">
                                                <i class="fas fa-user"></i> Nome
                                            </f:facet>
                                            <strong>#{usuario.nome}</strong>
                                        </h:column>
                                        
                                        <h:column>
                                            <f:facet name="header">
                                                <i class="fas fa-envelope"></i> Email
                                            </f:facet>
                                            #{usuario.email}
                                        </h:column>
                                        
                                        <h:column>
                                            <f:facet name="header">
                                                <i class="fas fa-shield-alt"></i> Perfil
                                            </f:facet>
                                            <h:panelGroup rendered="#{usuario.perfil == 'ADMIN'}">
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-crown"></i> Administrador
                                                </span>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{usuario.perfil == 'EDITOR'}">
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-edit"></i> Editor
                                                </span>
                                            </h:panelGroup>
                                        </h:column>
                                        
                                        <h:column>
                                            <f:facet name="header">
                                                <i class="fas fa-calendar"></i> Data Cadastro
                                            </f:facet>
                                            <h:outputText value="#{usuario.dataCadastro}">
                                                <f:convertDateTime pattern="dd/MM/yyyy"/>
                                            </h:outputText>
                                        </h:column>
                                        
                                        <h:column>
                                            <f:facet name="header">
                                                <i class="fas fa-cogs"></i> Ações
                                            </f:facet>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        data-bs-toggle="modal" data-bs-target="#modalUsuario"
                                                        onclick="#{usuarioController.editarUsuario(usuario.id)}"
                                                        title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                
                                                <h:commandLink action="#{usuarioController.excluir(usuario.id)}" 
                                                             styleClass="btn btn-sm btn-outline-danger"
                                                             title="Excluir"
                                                             rendered="#{usuario.id != loginController.usuarioLogado.id}"
                                                             onclick="return confirm('Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.')">
                                                    <i class="fas fa-trash"></i>
                                                </h:commandLink>
                                            </div>
                                        </h:column>
                                    </h:dataTable>
                                </div>
                                
                                <!-- Mensagem quando não há usuários -->
                                <h:panelGroup rendered="#{empty usuarioController.usuarios}">
                                    <div class="text-center py-5">
                                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                        <h4 class="text-muted">Nenhum usuário encontrado</h4>
                                        <p class="text-muted">Ajuste os filtros ou crie um novo usuário!</p>
                                    </div>
                                </h:panelGroup>
                            </h:form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal de Usuário -->
        <div class="modal fade" id="modalUsuario" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <h:form>
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas #{usuarioController.usuario.id == null ? 'fa-plus' : 'fa-edit'}"></i>
                                #{usuarioController.usuario.id == null ? 'Novo' : 'Editar'} Usuário
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        
                        <div class="modal-body">
                            <!-- Mensagens do modal -->
                            <h:messages styleClass="alert alert-danger" 
                                       showDetail="true" showSummary="false"/>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <!-- Nome -->
                                    <div class="mb-3">
                                        <label for="nomeUsuario" class="form-label">
                                            <i class="fas fa-user"></i> Nome *
                                        </label>
                                        <h:inputText id="nomeUsuario" value="#{usuarioController.usuario.nome}" 
                                                   styleClass="form-control" 
                                                   placeholder="Digite o nome completo"
                                                   required="true"
                                                   requiredMessage="Nome é obrigatório"/>
                                        <h:message for="nomeUsuario" styleClass="text-danger small"/>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <!-- Email -->
                                    <div class="mb-3">
                                        <label for="emailUsuario" class="form-label">
                                            <i class="fas fa-envelope"></i> Email *
                                        </label>
                                        <h:inputText id="emailUsuario" value="#{usuarioController.usuario.email}" 
                                                   styleClass="form-control" 
                                                   placeholder="Digite o email"
                                                   required="true"
                                                   requiredMessage="Email é obrigatório">
                                            <f:validator validatorId="emailValidator"/>
                                        </h:inputText>
                                        <h:message for="emailUsuario" styleClass="text-danger small"/>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <!-- Senha -->
                                    <div class="mb-3">
                                        <label for="senhaUsuario" class="form-label">
                                            <i class="fas fa-lock"></i> 
                                            #{usuarioController.usuario.id == null ? 'Senha *' : 'Nova Senha (deixe em branco para manter)'}
                                        </label>
                                        <h:inputSecret id="senhaUsuario" value="#{usuarioController.senha}" 
                                                     styleClass="form-control" 
                                                     placeholder="Digite a senha"
                                                     required="#{usuarioController.usuario.id == null}"
                                                     requiredMessage="Senha é obrigatória"/>
                                        <h:message for="senhaUsuario" styleClass="text-danger small"/>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <!-- Perfil -->
                                    <div class="mb-3">
                                        <label for="perfilUsuario" class="form-label">
                                            <i class="fas fa-shield-alt"></i> Perfil *
                                        </label>
                                        <h:selectOneMenu id="perfilUsuario" value="#{usuarioController.usuario.perfil}" 
                                                       styleClass="form-select"
                                                       required="true"
                                                       requiredMessage="Perfil é obrigatório">
                                            <f:selectItem itemValue="" itemLabel="Selecione o perfil"/>
                                            <f:selectItems value="#{usuarioController.perfisDisponiveis}" 
                                                         var="perfil" 
                                                         itemValue="#{perfil}" 
                                                         itemLabel="#{perfil == 'ADMIN' ? 'Administrador' : 'Editor'}"/>
                                        </h:selectOneMenu>
                                        <h:message for="perfilUsuario" styleClass="text-danger small"/>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Informações adicionais para edição -->
                            <h:panelGroup rendered="#{usuarioController.usuario.id != null}">
                                <hr/>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Data de Cadastro:</strong>
                                        <h:outputText value="#{usuarioController.usuario.dataCadastro}">
                                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm"/>
                                        </h:outputText>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Última Atualização:</strong>
                                        <h:outputText value="#{usuarioController.usuario.dataAtualizacao}">
                                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm"/>
                                        </h:outputText>
                                    </div>
                                </div>
                            </h:panelGroup>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <h:commandButton value="#{usuarioController.usuario.id == null ? 'Criar' : 'Salvar'}" 
                                           action="#{usuarioController.salvar}"
                                           styleClass="btn btn-primary"
                                           onclick="$('#modalUsuario').modal('hide');">
                                <i class="fas #{usuarioController.usuario.id == null ? 'fa-plus' : 'fa-save'}"></i>
                            </h:commandButton>
                        </div>
                    </h:form>
                </div>
            </div>
        </div>
        
        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    </f:view>
</h:body>
</html>